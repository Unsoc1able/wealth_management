<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Мой финансовый трекер</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.5;
      background: #f5f5f5;
    }

    body {
      max-width: 720px;
      margin: 0 auto;
      padding: 24px 16px 48px;
      background: #fff;
      color: #222;
    }

    h1, h2 {
      margin-top: 32px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    nav.tabs {
      display: flex;
      gap: 8px;
      margin: 24px 0;
    }

    nav.tabs button {
      flex: 1 1 160px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #0b7285;
      background: #fff;
      color: #0b7285;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    nav.tabs button.active {
      background: #0b7285;
      color: #fff;
    }

    form, section {
      background: #fafafa;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    label {
      display: block;
      margin-bottom: 12px;
      font-size: 0.95rem;
    }

    input, select, button {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d0d0d0;
      font-size: 1rem;
      box-sizing: border-box;
      margin-top: 6px;
    }

    button {
      background-color: #0b7285;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-top: 16px;
    }

    button:hover {
      background-color: #086073;
    }

    button.secondary {
      background-color: #e9ecef;
      color: #0b7285;
      border: 1px solid #d0d7dc;
    }

    button.secondary:hover {
      background-color: #dee2e6;
      color: #0b7285;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .row > label {
      flex: 1 1 200px;
    }

    ul, ol {
      padding-left: 20px;
    }

    .transaction-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .transaction-item:last-child {
      border-bottom: none;
    }

    .info-line {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.95rem;
    }

    .info-line strong {
      font-weight: 600;
    }

    .muted {
      color: #666;
      font-size: 0.85rem;
    }

    .empty-state {
      color: #888;
      font-style: italic;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
      margin-bottom: 12px;
    }

    .controls label {
      flex: 1 1 180px;
      margin-bottom: 0;
    }

    .controls button {
      flex: 0 0 auto;
      width: auto;
      min-width: 160px;
    }

    .status-line {
      min-height: 1.2em;
      margin: 4px 0 12px;
    }

    .summary-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }

    .summary-card {
      flex: 1 1 160px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .summary-card strong {
      display: block;
      font-size: 1.1rem;
      margin-bottom: 6px;
    }

    .summary-card span {
      display: block;
      color: #333;
    }

    .transaction-list {
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>
  <header>
    <h1>Мой финансовый трекер</h1>
    <p>Простое приложение для учёта доходов и расходов на базе Firebase Cloud Firestore.</p>
  </header>

  <main>
    <nav class="tabs">
      <button type="button" data-nav="operations" class="active">Операции</button>
      <button type="button" data-nav="analytics">Аналитика</button>
    </nav>

    <div class="view active" data-view="operations">
      <section>
        <h2>Добавить транзакцию</h2>
        <form id="transaction-form">
          <div class="row">
            <label>
              Дата
              <input type="date" id="date" required />
            </label>
            <label>
              Сумма
              <input type="number" id="amount" min="0.01" step="0.01" placeholder="0.00" required />
            </label>
          </div>

          <div class="row">
            <label>
              Тип операции
              <select id="type">
                <option value="expense">Расход</option>
                <option value="income">Доход</option>
              </select>
            </label>
            <label>
              Крупная категория
              <select id="major-category"></select>
            </label>
          </div>

          <label>
            Подкатегория
            <input type="text" id="sub-category" placeholder="например, продукты" />
          </label>

          <label>
            Комментарий
            <input type="text" id="note" placeholder="по желанию" />
          </label>

          <button type="submit">Сохранить</button>
        </form>
        <p id="form-status" class="muted"></p>
      </section>

      <section>
        <h2>Транзакции за месяц</h2>
        <div class="controls">
          <label>
            Месяц
            <input type="month" id="month-filter" />
          </label>
          <button type="button" id="refresh-button" class="secondary">Обновить данные</button>
        </div>
        <p id="refresh-status" class="muted status-line"></p>
        <div id="monthly-summary" class="summary-grid"></div>
        <div id="monthly-transactions" class="empty-state">Загрузка...</div>
      </section>
    </div>

    <div class="view" data-view="analytics">
      <section>
        <h2>Месячная динамика</h2>
        <div id="monthly-overview" class="empty-state">Загрузка...</div>
      </section>

      <section>
        <h2>Крупные категории (расходы)</h2>
        <div id="category-breakdown" class="empty-state">Загрузка...</div>
      </section>

      <section>
        <h2>Простой прогноз</h2>
        <div id="forecast" class="empty-state">Недостаточно данных для прогноза.</div>
      </section>

      <section>
        <h2>Последние транзакции</h2>
        <div id="recent-transactions" class="empty-state">Загрузка...</div>
      </section>
    </div>
  </main>

  <script type="module">
    // --- Firebase imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      onSnapshot,
      getDocs
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- Firebase initialization ---
    // Вставьте сюда собственный firebaseConfig (конфигурация из консоли Firebase)
    const firebaseConfig = {
    apiKey: "AIzaSyA3uIp1nzr_37lv8ik80yx3nWkSFRvCdUQ",
    authDomain: "wealth-managment-a62a7.firebaseapp.com",
    projectId: "wealth-managment-a62a7",
    storageBucket: "wealth-managment-a62a7.firebasestorage.app",
    messagingSenderId: "28529897223",
    appId: "1:28529897223:web:a9d3633563090fcdb85fa2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Настройки категорий ---
    const majorCategories = [
      { value: "everyday", label: "Повседневные" },
      { value: "housing", label: "Жильё" },
      { value: "transport", label: "Транспорт" },
      { value: "fun", label: "Развлечения" },
      { value: "investments", label: "Инвестиции" },
      { value: "other", label: "Другое" }
      // Добавьте новые категории в этот массив при необходимости
    ];

    const categorySelect = document.getElementById("major-category");
    majorCategories.forEach((category) => {
      const option = document.createElement("option");
      option.value = category.value;
      option.textContent = category.label;
      categorySelect.appendChild(option);
    });

    const views = document.querySelectorAll(".view");
    const navButtons = document.querySelectorAll("nav.tabs button");
    navButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const target = button.dataset.nav;
        navButtons.forEach((btn) => btn.classList.toggle("active", btn === button));
        views.forEach((view) => view.classList.toggle("active", view.dataset.view === target));
      });
    });

    const dateInput = document.getElementById("date");
    const monthFilterInput = document.getElementById("month-filter");
    const refreshButton = document.getElementById("refresh-button");
    const refreshStatus = document.getElementById("refresh-status");
    const form = document.getElementById("transaction-form");
    const formStatus = document.getElementById("form-status");
    const monthlySummaryEl = document.getElementById("monthly-summary");
    const monthlyTransactionsEl = document.getElementById("monthly-transactions");
    const monthlyOverviewEl = document.getElementById("monthly-overview");
    const categoryBreakdownEl = document.getElementById("category-breakdown");
    const forecastEl = document.getElementById("forecast");
    const recentTransactionsEl = document.getElementById("recent-transactions");

    // --- Установка дат по умолчанию ---
    const setToday = () => {
      const now = new Date();
      dateInput.value = now.toISOString().split("T")[0];
    };

    const setCurrentMonth = () => {
      const now = new Date();
      const monthValue = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
      if (monthFilterInput) {
        monthFilterInput.value = monthValue;
      }
    };

    setToday();
    setCurrentMonth();

    let allTransactions = [];
    let unsubscribe = null;

    if (monthFilterInput) {
      monthFilterInput.addEventListener("change", () => updateMonthlyTransactions(allTransactions));
    }

    if (refreshButton) {
      refreshButton.addEventListener("click", manualRefresh);
    }

    // --- Добавление новой транзакции ---
    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      const dateValue = dateInput.value;
      const amountValue = parseFloat(document.getElementById("amount").value || "0");
      const typeValue = document.getElementById("type").value;
      const majorCategoryValue = categorySelect.value;
      const subCategoryValue = document.getElementById("sub-category").value.trim();
      const noteValue = document.getElementById("note").value.trim();

      if (!dateValue || !amountValue || amountValue <= 0) {
        formStatus.textContent = "Пожалуйста, заполните дату и сумму больше 0.";
        return;
      }

      formStatus.textContent = "Сохранение...";

      try {
        await addDoc(collection(db, "transactions"), {
          date: new Date(dateValue),
          amount: amountValue,
          type: typeValue,
          majorCategory: majorCategoryValue,
          subCategory: subCategoryValue || null,
          note: noteValue || null,
          createdAt: serverTimestamp()
        });

        form.reset();
        setToday();
        formStatus.textContent = "Готово! Транзакция добавлена.";
      } catch (error) {
        console.error("Ошибка при добавлении транзакции", error);
        formStatus.textContent = getFriendlyErrorMessage(error);
      }
    });

    function getFriendlyErrorMessage(error) {
      const baseMessage = "Не удалось сохранить. Проверьте настройки Firebase.";
      if (!error) return baseMessage;

      if (error.code === "permission-denied") {
        return "Нет прав на запись: проверьте правила безопасности Cloud Firestore.";
      }

      if (error.code === "unavailable") {
        return "Сервис Firestore временно недоступен. Попробуйте позже.";
      }

      if (error.code === "failed-precondition") {
        return "Требуется индекс Firestore. Создайте индекс по подсказке в консоли.";
      }

      if (error.message) {
        return `${baseMessage} (${error.message})`;
      }

      return baseMessage;
    }

    // --- Подписка на изменения в коллекции ---
    const transactionsQuery = query(
      collection(db, "transactions"),
      orderBy("date", "desc"),
      orderBy("createdAt", "desc")
    );

    subscribeToTransactions();

    function subscribeToTransactions() {
      if (unsubscribe) {
        unsubscribe();
      }

      unsubscribe = onSnapshot(
        transactionsQuery,
        (snapshot) => {
          allTransactions = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data()
          }));

          applyAllUpdates();

          if (refreshStatus) {
            refreshStatus.textContent = "";
          }
        },
        (error) => {
          console.error("Ошибка подписки на транзакции", error);
          if (refreshStatus) {
            refreshStatus.textContent = getFriendlyErrorMessage(error);
          }
        }
      );
    }

    async function manualRefresh() {
      if (!refreshButton) return;

      refreshButton.disabled = true;
      if (refreshStatus) {
        refreshStatus.textContent = "Обновление...";
      }

      try {
        const snapshot = await getDocs(transactionsQuery);
        allTransactions = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data()
        }));

        applyAllUpdates();

        if (refreshStatus) {
          refreshStatus.textContent = "Данные обновлены.";
          setTimeout(() => {
            if (refreshStatus.textContent === "Данные обновлены.") {
              refreshStatus.textContent = "";
            }
          }, 3000);
        }
      } catch (error) {
        console.error("Ошибка ручного обновления", error);
        if (refreshStatus) {
          refreshStatus.textContent = getFriendlyErrorMessage(error);
        }
      } finally {
        refreshButton.disabled = false;
      }
    }

    function applyAllUpdates() {
      updateMonthlyTransactions(allTransactions);
      updateMonthlyOverview(allTransactions);
      updateCategoryBreakdown(allTransactions);
      updateForecast(allTransactions);
      updateRecentTransactions(allTransactions);
    }

    // Унифицированная нормализация даты (Firestore Timestamp, Date или строка)
    function normalizeDate(value) {
      if (!value) return null;
      const base = value.toDate ? value.toDate() : value;
      const date = base instanceof Date ? base : new Date(base);
      return Number.isNaN(date.getTime()) ? null : date;
    }

    function updateMonthlyTransactions(transactions) {
      if (!monthlyTransactionsEl) return;

      const monthValue = monthFilterInput?.value;
      if (!monthValue) {
        monthlyTransactionsEl.textContent = "Выберите месяц для отображения операций.";
        monthlyTransactionsEl.classList.add("empty-state");
        if (monthlySummaryEl) {
          monthlySummaryEl.innerHTML = "";
        }
        return;
      }

      const [yearStr, monthStr] = monthValue.split("-");
      const year = Number(yearStr);
      const month = Number(monthStr);

      if (!year || !month) {
        monthlyTransactionsEl.textContent = "Не удалось определить месяц.";
        monthlyTransactionsEl.classList.add("empty-state");
        if (monthlySummaryEl) {
          monthlySummaryEl.innerHTML = "";
        }
        return;
      }

      const filtered = transactions.filter((tx) => {
        const date = normalizeDate(tx.date);
        return date && date.getFullYear() === year && date.getMonth() + 1 === month;
      });

      if (!filtered.length) {
        monthlyTransactionsEl.textContent = "За выбранный месяц пока нет данных.";
        monthlyTransactionsEl.classList.add("empty-state");
        if (monthlySummaryEl) {
          monthlySummaryEl.innerHTML = "";
        }
        return;
      }

      let incomeTotal = 0;
      let expenseTotal = 0;

      const list = document.createElement("div");
      list.className = "transaction-list";

      filtered
        .slice()
        .sort((a, b) => {
          const dateA = normalizeDate(a.date);
          const dateB = normalizeDate(b.date);
          return (dateB?.getTime() || 0) - (dateA?.getTime() || 0);
        })
        .forEach((tx) => {
          if (tx.type === "income") {
            incomeTotal += tx.amount;
          } else if (tx.type === "expense") {
            expenseTotal += tx.amount;
          }

          const date = normalizeDate(tx.date) || new Date();
          const categoryName =
            majorCategories.find((c) => c.value === tx.majorCategory)?.label || tx.majorCategory || "Без категории";
          const sign = tx.type === "income" ? "+" : "-";
          const item = document.createElement("div");
          item.className = "transaction-item";
          item.innerHTML = `
            <div class="info-line">
              <span>${date.toLocaleDateString()}</span>
              <strong>${sign}${tx.amount.toFixed(2)}</strong>
            </div>
            <div class="muted">${categoryName}${tx.subCategory ? ` / ${tx.subCategory}` : ""}</div>
            ${tx.note ? `<div>${tx.note}</div>` : ""}
          `;
          list.appendChild(item);
        });

      monthlyTransactionsEl.classList.remove("empty-state");
      monthlyTransactionsEl.innerHTML = "";
      monthlyTransactionsEl.appendChild(list);

      if (monthlySummaryEl) {
        const net = incomeTotal - expenseTotal;
        const totalOperations = filtered.length;
        const monthLabel = new Intl.DateTimeFormat("ru-RU", {
          month: "long",
          year: "numeric"
        }).format(new Date(year, month - 1));
        const formattedMonth = monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1);
        monthlySummaryEl.innerHTML = `
          <div class="summary-card">
            <strong>Месяц</strong>
            <span>${formattedMonth}</span>
          </div>
          <div class="summary-card">
            <strong>Доходы</strong>
            <span>${incomeTotal.toFixed(2)}</span>
          </div>
          <div class="summary-card">
            <strong>Расходы</strong>
            <span>${expenseTotal.toFixed(2)}</span>
          </div>
          <div class="summary-card">
            <strong>Баланс</strong>
            <span>${net.toFixed(2)}</span>
          </div>
          <div class="summary-card">
            <strong>Операций</strong>
            <span>${totalOperations}</span>
          </div>
        `;
      }
    }

    // --- Аналитика: Месячная динамика ---
    function updateMonthlyOverview(transactions) {
      if (!transactions.length) {
        monthlyOverviewEl.textContent = "Пока нет данных.";
        monthlyOverviewEl.classList.add("empty-state");
        return;
      }

      const monthlyMap = new Map();

      transactions.forEach((tx) => {
        const date = normalizeDate(tx.date);
        if (!date) return;
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
        if (!monthlyMap.has(key)) {
          monthlyMap.set(key, { income: 0, expense: 0 });
        }
        const record = monthlyMap.get(key);
        if (tx.type === "income") {
          record.income += tx.amount;
        } else if (tx.type === "expense") {
          record.expense += tx.amount;
        }
      });

      const sortedEntries = Array.from(monthlyMap.entries()).sort((a, b) => (a[0] > b[0] ? -1 : 1));
      monthlyOverviewEl.classList.remove("empty-state");
      monthlyOverviewEl.innerHTML = "";

      const list = document.createElement("ul");
      sortedEntries.forEach(([month, values]) => {
        const net = values.income - values.expense;
        const item = document.createElement("li");
        item.innerHTML = `<strong>${month}</strong>: доход ${values.income.toFixed(2)}, расход ${values.expense.toFixed(2)}, нетто ${net.toFixed(2)}`;
        list.appendChild(item);
      });

      monthlyOverviewEl.appendChild(list);
    }

    // --- Аналитика: Крупные категории ---
    function updateCategoryBreakdown(transactions) {
      const expenses = transactions.filter((tx) => tx.type === "expense");

      if (!expenses.length) {
        categoryBreakdownEl.textContent = "Расходов пока нет.";
        categoryBreakdownEl.classList.add("empty-state");
        return;
      }

      const categoryTotals = new Map();
      const monthsSet = new Set();

      expenses.forEach((tx) => {
        const date = normalizeDate(tx.date);
        if (!date) return;
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
        monthsSet.add(monthKey);
        const key = tx.majorCategory || "other";
        categoryTotals.set(key, (categoryTotals.get(key) || 0) + tx.amount);
      });

      const monthsCount = monthsSet.size || 1;

      categoryBreakdownEl.classList.remove("empty-state");
      categoryBreakdownEl.innerHTML = "";

      const list = document.createElement("ul");
      categoryTotals.forEach((total, key) => {
        const categoryName = majorCategories.find((c) => c.value === key)?.label || key;
        const avg = total / monthsCount;
        const item = document.createElement("li");
        item.textContent = `${categoryName} — всего ${total.toFixed(2)}, в среднем ${avg.toFixed(2)} в месяц`;
        list.appendChild(item);
      });

      categoryBreakdownEl.appendChild(list);
    }

    // --- Аналитика: Прогноз ---
    function updateForecast(transactions) {
      const monthlyMap = new Map();

      transactions.forEach((tx) => {
        const date = normalizeDate(tx.date);
        if (!date) return;
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
        if (!monthlyMap.has(key)) {
          monthlyMap.set(key, { income: 0, expense: 0 });
        }
        const record = monthlyMap.get(key);
        if (tx.type === "income") {
          record.income += tx.amount;
        } else if (tx.type === "expense") {
          record.expense += tx.amount;
        }
      });

      const sorted = Array.from(monthlyMap.entries())
        .sort((a, b) => (a[0] > b[0] ? -1 : 1))
        .slice(0, 3);

      if (sorted.length < 2) {
        forecastEl.textContent = "Недостаточно данных для прогноза.";
        forecastEl.classList.add("empty-state");
        return;
      }

      const netValues = sorted.map(([_, values]) => values.income - values.expense);
      const averageNet = netValues.reduce((sum, value) => sum + value, 0) / netValues.length;
      const twoMonthForecast = averageNet * 2;

      forecastEl.classList.remove("empty-state");
      forecastEl.innerHTML = `
        <p>Ожидаемый средний месячный нетто-результат: <strong>${averageNet.toFixed(2)}</strong></p>
        <p>Прогноз на 2 месяца: <strong>${twoMonthForecast.toFixed(2)}</strong></p>
        <p class="muted">Учитываются последние ${sorted.length} месяца(ев) с данными.</p>
      `;
    }

    // --- Список последних транзакций ---
    function updateRecentTransactions(transactions) {
      if (!transactions.length) {
        recentTransactionsEl.textContent = "Пока нет данных.";
        recentTransactionsEl.classList.add("empty-state");
        return;
      }

      const sorted = [...transactions]
        .sort((a, b) => {
          const dateA = normalizeDate(a.date);
          const dateB = normalizeDate(b.date);
          return (dateB?.getTime() || 0) - (dateA?.getTime() || 0);
        })
        .slice(0, 10);

      recentTransactionsEl.classList.remove("empty-state");
      recentTransactionsEl.innerHTML = "";

      sorted.forEach((tx) => {
        const date = normalizeDate(tx.date) || new Date();
        const categoryName = majorCategories.find((c) => c.value === tx.majorCategory)?.label || tx.majorCategory || "Без категории";
        const sign = tx.type === "income" ? "+" : "-";
        const item = document.createElement("div");
        item.className = "transaction-item";
        item.innerHTML = `
          <div class="info-line">
            <span>${date.toLocaleDateString()}</span>
            <strong>${sign}${tx.amount.toFixed(2)}</strong>
          </div>
          <div class="muted">${categoryName}${tx.subCategory ? ` / ${tx.subCategory}` : ""}</div>
          ${tx.note ? `<div>${tx.note}</div>` : ""}
        `;
        recentTransactionsEl.appendChild(item);
      });
    }
  </script>
</body>
</html>
